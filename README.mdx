# Import Data from CRM

The documentation is about the current import system it need to be simplified and factorized

_can be factorized_

## Step 1 Oauth management

- _Create endpoint to retreive oauth2 url connection_
- _Create a new table for the CRM Connection_
- _Create a callback endpoint for oauth2_

  - _ Save the object_
  - _ Manage if already existing connection_
  - _ Reactivate if soft deleted_

- Create a delete endpoint for oauth2
  _Soft delete_

## Step 2 Schema management

- _Create a new table for the CRM schema_
- _
  Edit table sheet to add the field for this CRM schema
  _
- Endpoint to retrieve all table in the CRM
- Endpoint to retrieve all fields and metadata for a CRM table
- _
  Endpoint to create / edit new import schema (link to one connection)
  _

  - _ Save the object_
  - _ Reactivate if soft deleted_
  - _ Implement a before save hook to_
    ensure the presence of the id in the import schema{" "}
  - _ Implement an after save_
    hook to create / delete / edit all business object{" "}
  - _ Import the data_

## Step 3 Other endpoint and helper

- Create an endpoint to get all users from the user table of the CRM
- _
  Create an endpoint to retrieve all import schema for one connection
  _
- _Create an endpoint to retrieve a import schema_
- Create the helper to instanciate connection
  - Refresh token if necessary

## Step 4 import the data

Each import schema is linked to one connection and one sheet

- Implement a function who from an import schema scan the CRM and format the data
  - Check if soft deleted import schema
  - Check if soft deleted connection
  - Based on last import date
  - Format data for clickhouse / insert it
- _
  Implement a function who scan all sheets linked to one type of CRM for a
  company and use the previous function to import it
  _

- _Add it to the cron_

- _
  Create an endpoint to force the import for one organization
  _
- _
  Edit one endpoint with the new field for import schema
  _

---

### Other point who need reflexion

- Queuing
- Smart retry
- Check on api limit
- Maybe pass by webhooks / problem all CRM doesn't support it
- How to get updated and informed on all CRM's api changes
- The need for one library for each CRM
